<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Comment Report Tool - Curro Rivonia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase v10 -->
    <script type="module">
        // This will be moved to inline script
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Login Page Styles */
        #loginPage {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 50px;
            max-width: 450px;
            width: 100%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            color: #0066B3;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1.1em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0066B3;
        }

        .login-btn {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 179, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 10px;
        }

        .user-email {
            color: white;
            font-size: 0.9em;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        #mainApp {
            display: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #0066B3;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #004d87;
            background: #f0f0f5;
        }

        .upload-section h3 {
            color: #0066B3;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .file-input-wrapper {
            position: relative;
            margin: 15px 0;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 179, 0.4);
        }

        .file-name {
            display: inline-block;
            margin-left: 15px;
            color: #666;
            font-style: italic;
        }

        .btn {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 102, 179, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .results-container {
            margin-top: 30px;
            display: none;
        }

        .student-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .student-card:hover {
            border-color: #0066B3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-header {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .student-header h3 {
            font-size: 1.3em;
        }

        .student-number {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
        }

        .subject-row {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #0066B3;
        }

        .subject-name {
            font-weight: 700;
            color: #0066B3;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .subject-teacher {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .subject-mark {
            display: inline-block;
            background: #0066B3;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .comment {
            color: #333;
            line-height: 1.6;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            white-space: pre-wrap;
        }

        .spelling-error {
            background: #fff3cd;
            border-bottom: 2px wavy #dc3545;
            cursor: help;
            padding: 0 2px;
            position: relative;
        }

        .spelling-error:hover {
            background: #ffe69c;
        }

        .pronoun-error {
            background: #f8d7da;
            border-bottom: 2px wavy #dc3545;
            cursor: help;
            padding: 0 2px;
            font-weight: 600;
        }

        .pronoun-error:hover {
            background: #f5c6cb;
        }

        .spelling-stats {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .spelling-stats h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .spelling-word {
            display: inline-block;
            background: white;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 5px;
            font-family: monospace;
            border: 1px solid #ffc107;
        }

        .no-errors {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .spell-check-toggle {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 15px;
            background: #ffc107;
            color: #000;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spell-check-toggle:hover {
            background: #ffca2c;
        }

        .spell-check-loading {
            color: #666;
            font-style: italic;
            padding: 10px;
        }

        .progress-container {
            margin: 20px 0;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .checking-message {
            text-align: center;
            color: #0066B3;
            font-size: 1.1em;
            margin: 10px 0;
            font-weight: 600;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
        }

        .name-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .name-status.matched {
            background: #d4edda;
            color: #155724;
        }

        .name-status.original {
            background: #fff3cd;
            color: #856404;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <h1>üìã Comment Tool</h1>
                <p>Curro Rivonia School</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required placeholder="your.email@curro.co.za">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="loginError" class="login-error"></div>
                <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp">
    <div class="container">
        <div class="header">
            <h1>üìã Subject Comment Report Tool</h1>
            <p>Process and validate student comments with name cross-referencing</p>
            <div class="user-info">
                <span class="user-email" id="userEmail"></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="upload-section">
                <h3>üìÅ Upload Files</h3>
                
                <div class="file-input-wrapper">
                    <input type="file" id="commentReportFile" accept=".xlsx,.xls">
                    <label for="commentReportFile" class="file-input-label">
                        üìÑ Choose Comment Report
                    </label>
                    <span class="file-name" id="commentReportName">No file chosen</span>
                </div>

                <div class="file-input-wrapper">
                    <input type="file" id="educatorListFile" accept=".xlsx,.xls">
                    <label for="educatorListFile" class="file-input-label">
                        üìä Choose Educator List
                    </label>
                    <span class="file-name" id="educatorListName">No file chosen</span>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="status"></div>

            <!-- Progress Bar -->
            <div id="progressContainer" style="display: none;">
                <div class="checking-message" id="checkingMessage">Checking quality...</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center;">
                <button class="btn" id="processBtn" onclick="processFiles()" disabled>
                    üöÄ Process Files & Check Quality
                </button>
                <button class="btn" id="downloadPdfBtn" onclick="downloadErrorsPDF()" disabled style="display: none; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    üìÑ Download Error Report (PDF)
                </button>
                <button class="btn" id="resetBtn" onclick="resetTool()" style="display: none; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                    üîÑ Reset & Upload New Batch
                </button>
            </div>

            <!-- Statistics -->
            <div id="statsContainer" style="display: none;">
                <h3 style="color: #0066B3; margin: 30px 0 20px 0;">üìä Processing Statistics</h3>
                <div class="stats">
                    <div class="stat-card">
                        <h4>Total Students</h4>
                        <div class="number" id="totalStudents">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Names Matched</h4>
                        <div class="number" id="namesMatched">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Original Names</h4>
                        <div class="number" id="namesOriginal">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Subjects</h4>
                        <div class="number" id="totalSubjects">0</div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="resultsContainer" class="results-container">
                <h3 style="color: #0066B3; margin: 30px 0 20px 0;">‚úÖ Processed Students</h3>
                <div id="studentCards"></div>
            </div>
        </div>
    </div>

    <script>
        let commentReportData = null;
        let educatorListData = null;
        let processedData = null;
        let studentNameMap = new Map();
        let studentGenderMap = new Map(); // Map of student number -> gender
        let spellCheckEnabled = false;
        let qualityIssues = new Map(); // Map of student index -> array of quality issues (spelling + pronouns)
        let isCheckingQuality = false;

        // LanguageTool API configuration
        const LANGUAGETOOL_API = 'https://api.languagetool.org/v2/check';
        const BATCH_SIZE = 10; // Comments per request
        const DELAY_BETWEEN_REQUESTS = 3100; // 3.1 seconds to stay under 20 req/min

        // School-specific rules and prohibited words
        const prohibitedWords = {
            'but': 'however',
            'can': 'is able to',
            'needs': 'requires',
            'needed': 'required',
            'need': 'require',
            'struggles': 'finds it challenging',
            'student': 'learner',
            'students': 'learners',
            'you': '[remove - do not address learner directly]',
            'your': '[remove - do not address learner directly]',
            // US spellings
            'organize': 'organise',
            'organized': 'organised',
            'organizing': 'organising',
            'recognize': 'recognise',
            'recognized': 'recognised',
            'recognizing': 'recognising',
            'realize': 'realise',
            'realized': 'realised',
            'realizing': 'realising',
            'emphasize': 'emphasise',
            'emphasized': 'emphasised',
            'emphasizing': 'emphasising',
            'finalize': 'finalise',
            'finalized': 'finalised',
            'finalizing': 'finalising',
            'symbolize': 'symbolise',
            'symbolized': 'symbolised',
            'symbolizing': 'symbolising',
            'centralize': 'centralise',
            'characterize': 'characterise',
            'dramatize': 'dramatise',
            'materialize': 'materialise',
            'mobilize': 'mobilise',
            'modernize': 'modernise',
            'penalize': 'penalise',
            'socialize': 'socialise',
            'stabilize': 'stabilise'
        };

        const subjectNames = [
            'Accounting', 'Visual Arts', 'Tourism', 'Social Sciences',
            'Portuguese Second Additional Language', 'Physical Sciences',
            'Physical Education', 'Natural Sciences and Technology',
            'Natural Sciences', 'Music', 'Mathematics', 'Mathematical Literacy',
            'Life Skills', 'Life Sciences', 'Life Orientation',
            'isiZulu First Additional Language', 'Information Technology',
            'History', 'Geography', 'French Second Additional Language',
            'English Home Language', 'Engineering Graphics and Design',
            'Economics', 'Economic and Management Sciences', 'Dramatic Arts',
            'Critical Skills', 'Creative Arts', 'Computer Applications Technology',
            'Coding and Robotics', 'Business Studies',
            'Afrikaans First Additional Language', 'Advanced Programme Mathematics',
            'Advanced Programme English'
        ];

        // Simple UK English spell checker
        // Educational vocabulary and common words that should NOT be flagged
        const educationalTerms = new Set([
            'learner', 'learners', 'analyse', 'analysing', 'summarise', 'summarising',
            'behaviour', 'colour', 'favour', 'honour', 'labour', 'neighbour',
            'travelled', 'travelling', 'cancelled', 'cancelling', 'organise', 'organising',
            'realise', 'realising', 'recognise', 'recognising', 'practise', 'practising',
            'theatre', 'centre', 'metre', 'fibre', 'defence', 'offence', 'licence',
            'maths', 'programme', 'grey', 'modelling', 'jewellery', 'focussed', 'focussing',
            'amongst', 'whilst', 'towards', 'learnt', 'spelt', 'dreamt', 'burnt',
            'IEB', 'CAPS', 'DBE', 'Afrikaans', 'isiZulu', 'Donkerweb', 'Ubuntu', 'comprehension',
            // Common words that should never be flagged
            'for', 'the', 'and', 'but', 'with', 'from', 'have', 'this', 'that', 'will',
            'would', 'should', 'could', 'their', 'there', 'they', 'them', 'then', 'than',
            'when', 'where', 'which', 'while', 'what', 'been', 'being', 'were', 'was',
            'are', 'has', 'had', 'does', 'did', 'can', 'may', 'might', 'must', 'shall',
            'some', 'any', 'each', 'every', 'both', 'few', 'more', 'most', 'other',
            'such', 'only', 'own', 'same', 'than', 'too', 'very', 'just', 'well'
        ]);

        // Common proper nouns and names to ignore
        const properNouns = new Set([
            'Nalia', 'Lulama', 'Taygen', 'Curro', 'Rivonia', 'Shridhar'
        ]);

        // File input handlers
        document.getElementById('commentReportFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('commentReportName').textContent = file.name;
                readCommentReport(file);
            }
        });

        document.getElementById('educatorListFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('educatorListName').textContent = file.name;
                readEducatorList(file);
            }
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function readCommentReport(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    commentReportData = workbook;
                    showStatus(`‚úì Comment Report loaded (${workbook.SheetNames.length} sheets)`, 'success');
                    checkIfReadyToProcess();
                } catch (error) {
                    showStatus('‚úó Error reading Comment Report: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function readEducatorList(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    educatorListData = workbook;
                    
                    buildStudentNameMap(workbook);
                    
                    showStatus('‚úì Educator List loaded. Found ' + studentNameMap.size + ' students.', 'success');
                    checkIfReadyToProcess();
                } catch (error) {
                    showStatus('‚úó Error reading Educator List: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function buildStudentNameMap(workbook) {
            studentNameMap.clear();
            studentGenderMap.clear();
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: null});
            
            let headerRow = -1;
            for (let i = 0; i < data.length; i++) {
                if (data[i] && data[i][1] === 'Grade & Subject') {
                    headerRow = i;
                    break;
                }
            }
            
            if (headerRow === -1) {
                console.error('Could not find header row in Educator List');
                return;
            }
            
            for (let i = headerRow + 2; i < data.length; i++) {
                const row = data[i];
                if (!row) continue;
                
                const studentNumber = row[4]; // Column E: Student Number
                const studentName = row[6];   // Column G: Student Name
                const gender = row[10];       // Column K: Gender
                
                if (studentNumber && studentName) {
                    const numStr = studentNumber.toString().trim();
                    studentNameMap.set(numStr, studentName.toString().trim());
                    
                    if (gender) {
                        studentGenderMap.set(numStr, gender.toString().trim());
                    }
                }
            }
            
            console.log(`Built maps with ${studentNameMap.size} names and ${studentGenderMap.size} genders`);
        }

        function checkIfReadyToProcess() {
            if (commentReportData && educatorListData) {
                document.getElementById('processBtn').disabled = false;
            }
        }

        function extractStudentNumber(nameWithNumber) {
            const match = nameWithNumber.match(/\(([^)]+)\)/);
            return match ? match[1].trim() : null;
        }

        function resetTool() {
            // Confirm reset
            if (!confirm('Are you sure you want to reset? This will clear all current data and allow you to upload a new batch.')) {
                return;
            }
            
            // Clear all data
            commentReportData = null;
            educatorListData = null;
            processedData = null;
            qualityIssues.clear();
            studentNameMap.clear();
            studentGenderMap.clear();
            
            // Reset file inputs
            document.getElementById('commentReportFile').value = '';
            document.getElementById('educatorListFile').value = '';
            document.getElementById('commentReportName').textContent = 'No file chosen';
            document.getElementById('educatorListName').textContent = 'No file chosen';
            
            // Hide all results and stats
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            
            // Reset buttons
            document.getElementById('processBtn').disabled = true;
            document.getElementById('downloadPdfBtn').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'none';
            
            // Clear status message
            document.getElementById('statusMessage').className = 'status';
            document.getElementById('statusMessage').style.display = 'none';
            
            // Show success message
            showStatus('‚úì Tool reset successfully. You can now upload new files.', 'success');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function processFiles() {
            showStatus('üîÑ Processing files...', 'info');
            
            try {
                const students = [];
                let totalSubjects = 0;
                let namesMatched = 0;
                let namesOriginal = 0;
                
                commentReportData.SheetNames.forEach((sheetName, idx) => {
                    const sheet = commentReportData.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: null});
                    
                    let student = null;
                    
                    // IMPORTANT: XLSX.js skips leading empty columns!
                    // So column B in Excel becomes index 0 in the array
                    
                    // Get student name from row 5 (index 4), first non-empty column (index 0)
                    if (data.length > 4 && data[4] && data[4][0]) {
                        const originalName = data[4][0].toString().trim();
                        const studentNumber = extractStudentNumber(originalName);
                        
                        let finalName = originalName;
                        let nameMatched = false;
                        
                        if (studentNumber && studentNameMap.has(studentNumber)) {
                            const correctName = studentNameMap.get(studentNumber);
                            finalName = `${correctName} (${studentNumber})`;
                            nameMatched = true;
                            namesMatched++;
                        } else {
                            namesOriginal++;
                        }
                        
                        student = {
                            name: finalName,
                            originalName: originalName,
                            studentNumber: studentNumber,
                            nameMatched: nameMatched,
                            gender: studentGenderMap.get(studentNumber) || 'Unknown',
                            grade: '',
                            subjects: []
                        };
                    } else {
                        console.warn(`Sheet ${idx + 1}: No student name found`);
                        return;
                    }
                    
                    // Get grade from row 8 (index 7), Excel column L becomes array index 10
                    if (data.length > 7 && data[7] && data[7][10]) {
                        student.grade = data[7][10].toString().trim();
                    }
                    
                    // Process subjects starting from row 13 (index 12)
                    for (let i = 12; i < data.length; i++) {
                        const row = data[i];
                        if (!row) continue;
                        
                        // Excel column B becomes array index 0
                        const subjectName = row[0] ? row[0].toString().trim() : '';
                        // Excel column I becomes array index 7
                        const mark = row[7];
                        // Excel column J becomes array index 8
                        const teacher = row[8] ? row[8].toString().trim() : '';
                        
                        // Check if this is a subject header (has a mark)
                        if (subjectName && mark !== null && mark !== undefined && mark !== '' && !isNaN(mark)) {
                            const subject = {
                                name: subjectName,
                                mark: mark.toString(),
                                teacher: teacher,
                                comment: ''
                            };
                            
                            // Check next row for comment
                            if (i + 1 < data.length && data[i + 1] && data[i + 1][0]) {
                                const nextRowText = data[i + 1][0];
                                const nextRowMark = data[i + 1][7];
                                
                                // If next row has text but no mark, it's a comment
                                if (nextRowText && (nextRowMark === null || nextRowMark === undefined || nextRowMark === '')) {
                                    subject.comment = nextRowText.toString().trim();
                                }
                            }
                            
                            student.subjects.push(subject);
                            totalSubjects++;
                        }
                    }
                    
                    if (student && student.subjects.length > 0) {
                        students.push(student);
                    }
                });
                
                processedData = students;
                
                // Update statistics
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('namesMatched').textContent = namesMatched;
                document.getElementById('namesOriginal').textContent = namesOriginal;
                document.getElementById('totalSubjects').textContent = totalSubjects;
                document.getElementById('statsContainer').style.display = 'block';
                
                // Automatically run quality check
                showStatus('üîÑ Running quality checks (spelling & pronouns via LanguageTool)...', 'info');
                const qualityResults = await runQualityCheck();
                
                // Display results with quality highlighting
                displayResultsWithQualityCheck();
                
                // Show final status
                if (qualityResults.totalIssues === 0) {
                    showStatus(`‚úì Successfully processed ${students.length} students with ${totalSubjects} subjects. No quality issues found!`, 'success');
                } else {
                    let statusMsg = `‚úì Processed ${students.length} students with ${totalSubjects} subjects. `;
                    statusMsg += `Found ${qualityResults.totalIssues} issue(s): `;
                    const parts = [];
                    if (qualityResults.spellingCount > 0) parts.push(`${qualityResults.spellingCount} spelling`);
                    if (qualityResults.grammarCount > 0) parts.push(`${qualityResults.grammarCount} grammar`);
                    if (qualityResults.pronounCount > 0) parts.push(`${qualityResults.pronounCount} pronoun`);
                    statusMsg += parts.join(', ');
                    statusMsg += ` (${qualityResults.studentsAffected} students affected)`;
                    showStatus(statusMsg, 'info');
                }
                
                document.getElementById('downloadPdfBtn').style.display = 'inline-block';
                document.getElementById('downloadPdfBtn').disabled = false;
                document.getElementById('resetBtn').style.display = 'inline-block';
                
            } catch (error) {
                showStatus('‚úó Error processing files: ' + error.message, 'error');
                console.error(error);
            }
        }

        function displayResults(students) {
            const container = document.getElementById('studentCards');
            container.innerHTML = '';
            
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const nameStatus = student.nameMatched ? 
                    '<span class="name-status matched">‚úì Name Matched</span>' : 
                    '<span class="name-status original">Original Name</span>';
                
                let subjectsHTML = '';
                student.subjects.forEach(subject => {
                    subjectsHTML += `
                        <div class="subject-row">
                            <div class="subject-name">${subject.name}</div>
                            ${subject.teacher ? `<div class="subject-teacher">Teacher: ${subject.teacher}</div>` : ''}
                            ${subject.mark ? `<span class="subject-mark">Mark: ${subject.mark}</span>` : ''}
                            ${subject.comment ? `<div class="comment">${subject.comment}</div>` : ''}
                        </div>
                    `;
                });
                
                card.innerHTML = `
                    <div class="student-header">
                        <div>
                            <h3>${student.name}</h3>
                            <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">
                                Grade: ${student.grade}
                            </div>
                        </div>
                        <div>
                            ${nameStatus}
                        </div>
                    </div>
                    ${subjectsHTML}
                `;
                
                container.appendChild(card);
            });
            
            document.getElementById('resultsContainer').style.display = 'block';
        }

        function checkQuality(text, studentGender, studentName) {
            // Legacy function - now handled by runQualityCheck with LanguageTool
            return [];
        }

        function checkProhibitedWords(text) {
            const errors = [];
            const words = text.match(/\b[a-zA-Z]+\b/g) || [];
            
            words.forEach(word => {
                const lower = word.toLowerCase();
                if (prohibitedWords[lower]) {
                    errors.push({
                        word: word,
                        type: 'prohibited',
                        suggestion: prohibitedWords[lower],
                        message: 'Prohibited word - use school-approved alternative'
                    });
                }
            });
            
            return errors;
        }

        function checkSubjectCapitalization(text, subjectName) {
            const errors = [];
            
            // Check if subject name appears uncapitalized in the text
            subjectNames.forEach(correctName => {
                const variations = [
                    correctName.toLowerCase(),
                    correctName.charAt(0).toLowerCase() + correctName.slice(1)
                ];
                
                variations.forEach(variation => {
                    // Use word boundary to avoid partial matches
                    const regex = new RegExp(`\\b${variation}\\b`, 'gi');
                    const matches = [...text.matchAll(regex)];
                    
                    matches.forEach(match => {
                        // Check if it's not properly capitalized
                        const foundText = match[0];
                        if (foundText !== correctName) {
                            errors.push({
                                word: foundText,
                                type: 'capitalization',
                                suggestion: correctName,
                                message: 'Subject name must be properly capitalized'
                            });
                        }
                    });
                });
            });
            
            return errors;
        }

        function checkDirectAddress(text) {
            const errors = [];
            
            // Check for direct address patterns
            const directPatterns = [
                { pattern: /\byou\b/gi, word: 'you', message: 'Do not address learner directly' },
                { pattern: /\byour\b/gi, word: 'your', message: 'Do not address learner directly' }
            ];
            
            directPatterns.forEach(({ pattern, word, message }) => {
                const matches = [...text.matchAll(pattern)];
                matches.forEach(match => {
                    errors.push({
                        word: match[0],
                        type: 'direct-address',
                        suggestion: '[rewrite without direct address]',
                        message: message
                    });
                });
            });
            
            return errors;
        }

        function checkPronouns(text, studentGender, studentName) {
            const errors = [];
            
            if (!studentGender || studentGender === 'Unknown') {
                return errors; // Can't check if we don't know gender
            }
            
            // Get first name for more accurate matching
            const firstName = studentName.split(' ')[0];
            
            // Define correct pronouns based on gender
            const correctPronouns = {
                'Male': {
                    subject: ['he', 'He'],
                    object: ['him', 'Him'],
                    possessive: ['his', 'His'],
                    wrong: {
                        subject: ['she', 'She'],
                        object: ['her', 'Her'],
                        possessive: ['her', 'Her', 'hers', 'Hers']
                    }
                },
                'Female': {
                    subject: ['she', 'She'],
                    object: ['her', 'Her'],
                    possessive: ['her', 'Her', 'hers', 'Hers'],
                    wrong: {
                        subject: ['he', 'He'],
                        object: ['him', 'Him'],
                        possessive: ['his', 'His']
                    }
                }
            };
            
            const genderPronouns = correctPronouns[studentGender];
            if (!genderPronouns) return errors;
            
            // Check for wrong pronouns
            const words = text.split(/\b/);
            
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                
                // Check if this is a wrong subject pronoun (he/she)
                if (genderPronouns.wrong.subject.includes(word)) {
                    errors.push({
                        word: word,
                        type: 'pronoun',
                        category: 'subject',
                        suggestion: genderPronouns.subject[word === word.toLowerCase() ? 0 : 1],
                        message: `Wrong pronoun for ${studentGender.toLowerCase()} student`
                    });
                }
                
                // Check if this is a wrong object pronoun (him/her)
                else if (genderPronouns.wrong.object.includes(word)) {
                    errors.push({
                        word: word,
                        type: 'pronoun',
                        category: 'object',
                        suggestion: genderPronouns.object[word === word.toLowerCase() ? 0 : 1],
                        message: `Wrong pronoun for ${studentGender.toLowerCase()} student`
                    });
                }
                
                // Check if this is a wrong possessive pronoun (his/her/hers)
                else if (genderPronouns.wrong.possessive.includes(word)) {
                    // Determine correct capitalization
                    let suggestion = genderPronouns.possessive[0];
                    if (word[0] === word[0].toUpperCase()) {
                        suggestion = genderPronouns.possessive[1];
                    }
                    
                    errors.push({
                        word: word,
                        type: 'pronoun',
                        category: 'possessive',
                        suggestion: suggestion,
                        message: `Wrong pronoun for ${studentGender.toLowerCase()} student`
                    });
                }
            }
            
            return errors;
        }
        function checkSpelling(text) {
            const errors = [];
            // Split text into words, keeping track of positions
            const words = text.match(/\b[a-zA-Z]+(?:'[a-zA-Z]+)?\b/g) || [];
            
            // Track words we've already checked to avoid duplicates
            const checkedWords = new Set();
            
            words.forEach(word => {
                // Skip if already checked
                if (checkedWords.has(word.toLowerCase())) {
                    return;
                }
                checkedWords.add(word.toLowerCase());
                
                // Skip if it's a known term or proper noun
                const lowerWord = word.toLowerCase();
                if (educationalTerms.has(lowerWord) || properNouns.has(word)) {
                    return;
                }
                
                // Skip very short words (likely correct)
                if (word.length <= 2) {
                    return;
                }
                
                // Check common UK vs US spelling differences FIRST
                if (hasAmericanSpelling(word)) {
                    errors.push({
                        word: word,
                        type: 'american',
                        suggestion: getUKSpelling(word),
                        message: 'American spelling (should use UK English)'
                    });
                    return; // Don't check other things if it's an American spelling
                }
                
                // Check for common typos
                if (hasCommonTypo(word)) {
                    errors.push({
                        word: word,
                        type: 'typo',
                        suggestion: getTypoCorrection(word),
                        message: 'Spelling error'
                    });
                    return;
                }
                
                // Additional check using edit distance for common misspellings
                const possibleError = checkEditDistance(word);
                if (possibleError) {
                    errors.push({
                        word: word,
                        type: 'typo',
                        suggestion: possibleError,
                        message: 'Possible spelling error'
                    });
                }
            });
            
            return errors;
        }

        function checkEditDistance(word) {
            // Check if word is one character off from common words
            const commonWords = [
                'while', 'which', 'where', 'their', 'there', 'these', 'those',
                'would', 'should', 'could', 'might', 'right', 'write', 'through',
                'though', 'thought', 'therefore', 'however', 'because', 'between',
                'within', 'without', 'about', 'above', 'below', 'after', 'before',
                'during', 'since', 'until', 'unless', 'although', 'whether',
                'either', 'neither', 'another', 'other', 'every', 'several'
            ];
            
            const lower = word.toLowerCase();
            
            for (const correctWord of commonWords) {
                if (editDistance(lower, correctWord) === 1) {
                    // Preserve capitalization
                    if (word[0] === word[0].toUpperCase()) {
                        return correctWord.charAt(0).toUpperCase() + correctWord.slice(1);
                    }
                    return correctWord;
                }
            }
            
            return null;
        }

        function editDistance(a, b) {
            // Levenshtein distance (simple version)
            if (Math.abs(a.length - b.length) > 1) return 999; // Quick reject
            
            const matrix = [];
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        }

        function hasAmericanSpelling(word) {
            const americanPatterns = [
                { pattern: /ize$/, uk: 'ise' },
                { pattern: /izing$/, uk: 'ising' },
                { pattern: /ization$/, uk: 'isation' },
                { pattern: /yze$/, uk: 'yse' },
                { pattern: /yzing$/, uk: 'ysing' },
                { pattern: /or$/, uk: 'our', exceptions: ['error', 'horror', 'mirror', 'prior', 'senior', 'junior', 'interior', 'exterior'] },
                { pattern: /ored$/, uk: 'oured' },
                { pattern: /oring$/, uk: 'ouring' },
                { pattern: /er$/, uk: 're', words: ['theater', 'center', 'meter', 'fiber'] },
                { pattern: /ense$/, uk: 'ence', words: ['defense', 'offense', 'license'] },
                { pattern: /og$/, uk: 'ogue', words: ['catalog', 'dialog'] },
                { pattern: /eled$/, uk: 'elled' },
                { pattern: /eling$/, uk: 'elling' },
                { pattern: /eled$/, uk: 'elled' }
            ];
            
            for (const {pattern, uk, exceptions, words} of americanPatterns) {
                if (pattern.test(word)) {
                    if (exceptions && exceptions.includes(word.toLowerCase())) {
                        continue;
                    }
                    if (words && !words.includes(word.toLowerCase())) {
                        continue;
                    }
                    return true;
                }
            }
            return false;
        }

        function getUKSpelling(word) {
            const conversions = {
                'analyze': 'analyse',
                'analyzing': 'analysing',
                'analyzed': 'analysed',
                'organization': 'organisation',
                'organize': 'organise',
                'organizing': 'organising',
                'organized': 'organised',
                'realize': 'realise',
                'realizing': 'realising',
                'realized': 'realised',
                'recognize': 'recognise',
                'recognizing': 'recognising',
                'recognized': 'recognised',
                'color': 'colour',
                'colored': 'coloured',
                'coloring': 'colouring',
                'favor': 'favour',
                'favored': 'favoured',
                'favoring': 'favouring',
                'honor': 'honour',
                'honored': 'honoured',
                'honoring': 'honouring',
                'labor': 'labour',
                'labored': 'laboured',
                'laboring': 'labouring',
                'neighbor': 'neighbour',
                'traveled': 'travelled',
                'traveling': 'travelling',
                'canceled': 'cancelled',
                'canceling': 'cancelling',
                'theater': 'theatre',
                'center': 'centre',
                'meter': 'metre',
                'fiber': 'fibre',
                'defense': 'defence',
                'offense': 'offence',
                'license': 'licence',
                'practice': 'practise',
                'practicing': 'practising',
                'practiced': 'practised',
                'program': 'programme',
                'gray': 'grey'
            };
            
            return conversions[word.toLowerCase()] || word;
        }

        function hasCommonTypo(word) {
            const commonTypos = [
                'recieve', 'acheive', 'beleive', 'occured', 'occuring', 'begining',
                'arguement', 'untill', 'successfull', 'powerfull', 'carefull',
                'writting', 'commited', 'prefered', 'refered', 'seperating',
                'whily', 'Whily', 'wiht', 'teh', 'taht', 'thier', 'becuase',
                'definately', 'definatly', 'goverment', 'enviroment', 'experiance',
                'occassion', 'accomodate', 'embarass', 'harass', 'dissapoint',
                'neccessary', 'occassionally', 'publically', 'realy', 'seperate',
                'tommorow', 'tommorrow', 'usefull', 'wether', 'wheather',
                'wich', 'wich', 'yuo', 'adn', 'nad', 'abd', 'thna', 'hte',
                'practises', 'practises', 'recognision', 'reccomend', 'recomend',
                'persue', 'pursueing', 'refering', 'occurance', 'maintainance',
                'independant', 'persistant', 'existance', 'appearence', 'occured',
                'mispelt', 'judgement', 'acknowledgement'
            ];
            return commonTypos.includes(word.toLowerCase());
        }

        function getTypoCorrection(word) {
            const corrections = {
                'recieve': 'receive',
                'acheive': 'achieve',
                'beleive': 'believe',
                'occured': 'occurred',
                'occuring': 'occurring',
                'begining': 'beginning',
                'arguement': 'argument',
                'untill': 'until',
                'successfull': 'successful',
                'powerfull': 'powerful',
                'carefull': 'careful',
                'writting': 'writing',
                'commited': 'committed',
                'prefered': 'preferred',
                'refered': 'referred',
                'seperating': 'separating',
                'whily': 'while',
                'Whily': 'While',
                'wiht': 'with',
                'teh': 'the',
                'taht': 'that',
                'thier': 'their',
                'becuase': 'because',
                'definately': 'definitely',
                'definatly': 'definitely',
                'goverment': 'government',
                'enviroment': 'environment',
                'experiance': 'experience',
                'occassion': 'occasion',
                'accomodate': 'accommodate',
                'embarass': 'embarrass',
                'harass': 'harass',
                'dissapoint': 'disappoint',
                'neccessary': 'necessary',
                'occassionally': 'occasionally',
                'publically': 'publicly',
                'realy': 'really',
                'seperate': 'separate',
                'tommorow': 'tomorrow',
                'tommorrow': 'tomorrow',
                'usefull': 'useful',
                'wether': 'whether',
                'wheather': 'weather',
                'wich': 'which',
                'yuo': 'you',
                'adn': 'and',
                'nad': 'and',
                'abd': 'and',
                'thna': 'than',
                'hte': 'the',
                'practises': 'practises', // This is actually correct in UK English for the verb
                'recognision': 'recognition',
                'reccomend': 'recommend',
                'recomend': 'recommend',
                'persue': 'pursue',
                'pursueing': 'pursuing',
                'refering': 'referring',
                'occurance': 'occurrence',
                'maintainance': 'maintenance',
                'independant': 'independent',
                'persistant': 'persistent',
                'existance': 'existence',
                'appearence': 'appearance',
                'mispelt': 'misspelt',
                'judgement': 'judgement' // Both UK spellings acceptable
            };
            
            const lower = word.toLowerCase();
            if (corrections[lower]) {
                // Preserve capitalization
                const correction = corrections[lower];
                if (word[0] === word[0].toUpperCase()) {
                    return correction.charAt(0).toUpperCase() + correction.slice(1);
                }
                return correction;
            }
            return word;
        }

        async function checkSpellingWithLanguageTool(text, studentName) {
            // Extract first name and last name from student name
            const nameParts = studentName.replace(/\([^)]+\)/g, '').trim().split(/\s+/);
            const disabledRules = 'MORFOLOGIK_RULE_EN_GB'; // Disable spell check for names
            
            // Check with LanguageTool API
            const params = new URLSearchParams({
                text: text,
                language: 'en-GB', // UK English
                enabledOnly: 'false'
            });

            try {
                const response = await fetch(LANGUAGETOOL_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: params
                });

                if (!response.ok) {
                    console.error('LanguageTool API error:', response.status);
                    return [];
                }

                const data = await response.json();
                
                // Convert LanguageTool matches to our format
                const errors = [];
                data.matches.forEach(match => {
                    const word = text.substring(match.offset, match.offset + match.length);
                    
                    // Skip if the word is the student's name (any part)
                    if (nameParts.some(namePart => word.toLowerCase() === namePart.toLowerCase())) {
                        return;
                    }
                    
                    // Skip if it's just a suggestion, not an error
                    if (match.rule.issueType === 'typographical' || 
                        match.rule.issueType === 'misspelling' ||
                        match.rule.issueType === 'grammar') {
                        
                        const suggestion = match.replacements.length > 0 ? match.replacements[0].value : word;
                        
                        errors.push({
                            word: word,
                            type: match.rule.issueType === 'grammar' ? 'grammar' : 'typo',
                            suggestion: suggestion,
                            message: match.message,
                            offset: match.offset,
                            length: match.length
                        });
                    }
                });

                return errors;
            } catch (error) {
                console.error('LanguageTool API request failed:', error);
                return [];
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const checkingMessage = document.getElementById('checkingMessage');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressBar.textContent = Math.round(percent) + '%';
            }
            if (checkingMessage && message) {
                checkingMessage.textContent = message;
            }
        }

        async function runQualityCheck() {
            if (!processedData || isCheckingQuality) return;
            
            isCheckingQuality = true;
            qualityIssues.clear();
            
            // Show progress bar
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, 'Starting quality checks...');
            
            // Collect all comments with metadata
            const allComments = [];
            processedData.forEach((student, studentIdx) => {
                student.subjects.forEach((subject, subjectIdx) => {
                    if (subject.comment && subject.comment.trim()) {
                        allComments.push({
                            text: subject.comment,
                            studentIdx: studentIdx,
                            subjectName: subject.name,
                            student: student
                        });
                    }
                });
            });
            
            if (allComments.length === 0) {
                isCheckingQuality = false;
                document.getElementById('progressContainer').style.display = 'none';
                return { totalIssues: 0, spellingCount: 0, pronounCount: 0, grammarCount: 0, studentsAffected: 0 };
            }
            
            updateProgress(5, `Checking ${allComments.length} comments...`);
            
            let totalIssues = 0;
            let spellingCount = 0;
            let pronounCount = 0;
            let grammarCount = 0;
            
            // Process in batches
            const batches = [];
            for (let i = 0; i < allComments.length; i += BATCH_SIZE) {
                batches.push(allComments.slice(i, i + BATCH_SIZE));
            }
            
            let processedBatches = 0;
            
            for (const batch of batches) {
                // Check each comment in the batch
                const batchPromises = batch.map(async (commentData) => {
                    const issues = [];
                    
                    // 1. Check spelling with LanguageTool (pass student name to ignore it)
                    const spellingErrors = await checkSpellingWithLanguageTool(commentData.text, commentData.student.name);
                    issues.push(...spellingErrors);
                    
                    // 2. Check pronouns (local check)
                    const pronounErrors = checkPronouns(commentData.text, commentData.student.gender, commentData.student.name);
                    issues.push(...pronounErrors);
                    
                    // 3. Check prohibited words
                    const prohibitedErrors = checkProhibitedWords(commentData.text);
                    issues.push(...prohibitedErrors);
                    
                    // 4. Check subject capitalization
                    const capitalizationErrors = checkSubjectCapitalization(commentData.text, commentData.subjectName);
                    issues.push(...capitalizationErrors);
                    
                    // 5. Check for direct address
                    const directAddressErrors = checkDirectAddress(commentData.text);
                    issues.push(...directAddressErrors);
                    
                    return {
                        commentData: commentData,
                        issues: issues
                    };
                });
                
                const batchResults = await Promise.all(batchPromises);
                
                // Process batch results
                batchResults.forEach(result => {
                    if (result.issues.length > 0) {
                        const { commentData, issues } = result;
                        
                        // Count by type
                        issues.forEach(issue => {
                            if (issue.type === 'pronoun') pronounCount++;
                            else if (issue.type === 'grammar') grammarCount++;
                            else spellingCount++;
                        });
                        
                        totalIssues += issues.length;
                        
                        // Store issues
                        if (!qualityIssues.has(commentData.studentIdx)) {
                            qualityIssues.set(commentData.studentIdx, []);
                        }
                        
                        qualityIssues.get(commentData.studentIdx).push({
                            subject: commentData.subjectName,
                            issues: issues,
                            comment: commentData.text
                        });
                    }
                });
                
                processedBatches++;
                const progress = 5 + (processedBatches / batches.length) * 90;
                updateProgress(progress, `Checked ${processedBatches * BATCH_SIZE} of ${allComments.length} comments...`);
                
                // Wait between batches to respect rate limit (except for last batch)
                if (processedBatches < batches.length) {
                    await sleep(DELAY_BETWEEN_REQUESTS);
                }
            }
            
            updateProgress(100, 'Quality check complete!');
            await sleep(500);
            document.getElementById('progressContainer').style.display = 'none';
            
            isCheckingQuality = false;
            
            return { 
                totalIssues, 
                spellingCount, 
                pronounCount, 
                grammarCount,
                studentsAffected: qualityIssues.size 
            };
        }

        function highlightQualityIssues(text, issues) {
            if (issues.length === 0) return text;
            
            let highlightedText = text;
            // Sort issues by word length (longest first) to avoid partial replacements
            issues.sort((a, b) => b.word.length - a.word.length);
            
            issues.forEach(issue => {
                const regex = new RegExp(`\\b${issue.word}\\b`, 'g');
                const suggestion = issue.suggestion || issue.word;
                const cssClass = issue.type === 'pronoun' ? 'pronoun-error' : 'spelling-error';
                const title = issue.type === 'pronoun' ? 
                    `${issue.message}. Use: ${suggestion}` : 
                    `Suggested: ${suggestion}`;
                
                highlightedText = highlightedText.replace(regex, 
                    `<span class="${cssClass}" title="${title}">${issue.word}</span>`
                );
            });
            
            return highlightedText;
        }

        function displayResultsWithQualityCheck() {
            const container = document.getElementById('studentCards');
            container.innerHTML = '';
            
            processedData.forEach((student, studentIdx) => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const nameStatus = student.nameMatched ? 
                    '<span class="name-status matched">‚úì Name Matched</span>' : 
                    '<span class="name-status original">Original Name</span>';
                
                const hasIssues = qualityIssues.has(studentIdx);
                const studentIssueData = qualityIssues.get(studentIdx) || [];
                
                let subjectsHTML = '';
                student.subjects.forEach(subject => {
                    let commentHTML = subject.comment || '';
                    let issueStatsHTML = '';
                    
                    if (hasIssues) {
                        const subjectIssues = studentIssueData.find(e => e.subject === subject.name);
                        if (subjectIssues && subjectIssues.issues.length > 0) {
                            commentHTML = highlightQualityIssues(commentHTML, subjectIssues.issues);
                            
                            // Separate all error types
                            const spellingIssues = subjectIssues.issues.filter(i => i.type === 'typo');
                            const grammarIssues = subjectIssues.issues.filter(i => i.type === 'grammar');
                            const pronounIssues = subjectIssues.issues.filter(i => i.type === 'pronoun');
                            const prohibitedIssues = subjectIssues.issues.filter(i => i.type === 'prohibited');
                            const capitalizationIssues = subjectIssues.issues.filter(i => i.type === 'capitalization');
                            const directAddressIssues = subjectIssues.issues.filter(i => i.type === 'direct-address');
                            
                            let issuesList = '';
                            
                            if (spellingIssues.length > 0) {
                                issuesList += '<div style="margin-bottom: 10px;"><strong>üìù Spelling Issues:</strong><br>';
                                spellingIssues.forEach(issue => {
                                    issuesList += `<span class="spelling-word" title="${issue.message}">${issue.word} ‚Üí ${issue.suggestion}</span> `;
                                });
                                issuesList += '</div>';
                            }
                            
                            if (grammarIssues.length > 0) {
                                issuesList += '<div style="margin-bottom: 10px;"><strong>üìö Grammar Issues:</strong><br>';
                                grammarIssues.forEach(issue => {
                                    issuesList += `<span class="spelling-word" style="border-color: #ff9800;" title="${issue.message}">${issue.word} ‚Üí ${issue.suggestion}</span> `;
                                });
                                issuesList += '</div>';
                            }
                            
                            if (prohibitedIssues.length > 0) {
                                issuesList += '<div style="margin-bottom: 10px;"><strong>üö´ Prohibited Words:</strong><br>';
                                prohibitedIssues.forEach(issue => {
                                    issuesList += `<span class="spelling-word" style="border-color: #e74c3c; background: #fadbd8;" title="${issue.message}">${issue.word} ‚Üí ${issue.suggestion}</span> `;
                                });
                                issuesList += '</div>';
                            }
                            
                            if (capitalizationIssues.length > 0) {
                                issuesList += '<div style="margin-bottom: 10px;"><strong>üî§ Subject Capitalization:</strong><br>';
                                capitalizationIssues.forEach(issue => {
                                    issuesList += `<span class="spelling-word" style="border-color: #3498db;" title="${issue.message}">${issue.word} ‚Üí ${issue.suggestion}</span> `;
                                });
                                issuesList += '</div>';
                            }
                            
                            if (directAddressIssues.length > 0) {
                                issuesList += '<div style="margin-bottom: 10px;"><strong>‚ö†Ô∏è Direct Address (Remove):</strong><br>';
                                directAddressIssues.forEach(issue => {
                                    issuesList += `<span class="spelling-word" style="border-color: #e74c3c; background: #fadbd8;" title="${issue.message}">${issue.word}</span> `;
                                });
                                issuesList += '</div>';
                            }
                            
                            if (pronounIssues.length > 0) {
                                issuesList += `<div><strong>üë§ Pronoun Errors (Gender: ${student.gender}):</strong><br>`;
                                pronounIssues.forEach(issue => {
                                    issuesList += `<span class="spelling-word" style="border-color: #dc3545;" title="${issue.message}">${issue.word} ‚Üí ${issue.suggestion}</span> `;
                                });
                                issuesList += '</div>';
                            }
                            
                            issueStatsHTML = `
                                <div class="spelling-stats">
                                    <h4>‚ö† Quality Issues Found:</h4>
                                    ${issuesList}
                                </div>
                            `;
                        } else if (subject.comment) {
                            issueStatsHTML = '<div class="no-errors">‚úì No issues found</div>';
                        }
                    }
                    
                    subjectsHTML += `
                        <div class="subject-row">
                            <div class="subject-name">${subject.name}</div>
                            ${subject.teacher ? `<div class="subject-teacher">Teacher: ${subject.teacher}</div>` : ''}
                            ${subject.mark ? `<span class="subject-mark">Mark: ${subject.mark}</span>` : ''}
                            ${issueStatsHTML}
                            ${commentHTML ? `<div class="comment">${commentHTML}</div>` : ''}
                        </div>
                    `;
                });
                
                const issuesBadge = hasIssues ? '<span class="spell-check-toggle">‚ö† Has Quality Issues</span>' : '';
                
                card.innerHTML = `
                    <div class="student-header">
                        <div>
                            <h3>${student.name}</h3>
                            <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">
                                Grade: ${student.grade} | Gender: ${student.gender}
                            </div>
                        </div>
                        <div>
                            ${nameStatus}
                            ${issuesBadge}
                        </div>
                    </div>
                    ${subjectsHTML}
                `;
                
                container.appendChild(card);
            });
            
            document.getElementById('resultsContainer').style.display = 'block';
        }

        function downloadErrorsPDF() {
            if (!processedData || qualityIssues.size === 0) {
                showStatus('‚úó No errors to download', 'info');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); // Portrait
                
                // Title page
                doc.setFontSize(24);
                doc.setTextColor(0, 102, 179);
                doc.text('Comment Error Report', 105, 30, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('Curro Rivonia School', 105, 42, { align: 'center' });
                
                doc.setFontSize(11);
                doc.setTextColor(80, 80, 80);
                doc.text('Teacher Correction Guide', 105, 52, { align: 'center' });
                doc.text('Generated: ' + new Date().toLocaleDateString('en-ZA'), 105, 60, { align: 'center' });
                
                // Summary box
                doc.setFillColor(240, 245, 250);
                doc.roundedRect(30, 75, 150, 35, 3, 3, 'F');
                
                doc.setFontSize(12);
                doc.setTextColor(0, 102, 179);
                doc.setFont(undefined, 'bold');
                doc.text('Summary', 105, 85, { align: 'center' });
                doc.setFont(undefined, 'normal');
                
                // Calculate statistics
                let totalErrors = 0;
                let spellingCount = 0, grammarCount = 0, pronounCount = 0;
                let prohibitedCount = 0, capitalizationCount = 0, directAddressCount = 0;
                
                qualityIssues.forEach(studentIssues => {
                    studentIssues.forEach(si => {
                        totalErrors += si.issues.length;
                        si.issues.forEach(issue => {
                            switch(issue.type) {
                                case 'typo': spellingCount++; break;
                                case 'grammar': grammarCount++; break;
                                case 'pronoun': pronounCount++; break;
                                case 'prohibited': prohibitedCount++; break;
                                case 'capitalization': capitalizationCount++; break;
                                case 'direct-address': directAddressCount++; break;
                            }
                        });
                    });
                });
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Students with Errors: ${qualityIssues.size}`, 40, 95);
                doc.text(`Total Errors: ${totalErrors}`, 40, 102);
                doc.text(`Spelling: ${spellingCount} | Grammar: ${grammarCount} | Pronouns: ${pronounCount}`, 40, 109);
                
                // Group errors by subject
                const errorsBySubject = new Map();
                
                processedData.forEach((student, studentIdx) => {
                    if (qualityIssues.has(studentIdx)) {
                        const studentIssues = qualityIssues.get(studentIdx);
                        
                        studentIssues.forEach(subjectIssue => {
                            const subject = student.subjects.find(s => s.name === subjectIssue.subject);
                            const teacher = subject ? subject.teacher : '';
                            
                            if (!errorsBySubject.has(subjectIssue.subject)) {
                                errorsBySubject.set(subjectIssue.subject, {
                                    teacher: teacher,
                                    entries: []
                                });
                            }
                            
                            errorsBySubject.get(subjectIssue.subject).entries.push({
                                studentName: student.name.split('(')[0].trim(),
                                gender: student.gender,
                                comment: subjectIssue.comment,
                                issues: subjectIssue.issues
                            });
                        });
                    }
                });
                
                // Create pages for each subject
                errorsBySubject.forEach((subjectData, subjectName) => {
                    doc.addPage();
                    let yPos = 20;
                    
                    // Subject header
                    doc.setFillColor(0, 102, 179);
                    doc.rect(10, yPos - 6, 190, 12, 'F');
                    doc.setFontSize(14);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont(undefined, 'bold');
                    doc.text(subjectName, 15, yPos);
                    doc.setFontSize(10);
                    doc.text(`Teacher: ${subjectData.teacher}`, 140, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 15;
                    
                    // Process each student's errors
                    subjectData.entries.forEach(entry => {
                        // Check if we need a new page
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 20;
                            // Repeat header
                            doc.setFillColor(0, 102, 179);
                            doc.rect(10, yPos - 6, 190, 10, 'F');
                            doc.setFontSize(12);
                            doc.setTextColor(255, 255, 255);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${subjectName} (continued)`, 15, yPos);
                            doc.setFont(undefined, 'normal');
                            yPos += 15;
                        }
                        
                        // Student name in blue box
                        doc.setFillColor(230, 240, 250);
                        doc.rect(10, yPos - 5, 190, 8, 'F');
                        doc.setFontSize(11);
                        doc.setTextColor(0, 102, 179);
                        doc.setFont(undefined, 'bold');
                        doc.text(`${entry.studentName} (${entry.gender})`, 15, yPos);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(0, 0, 0);
                        yPos += 10;
                        
                        // Error count badge
                        doc.setFontSize(9);
                        doc.setTextColor(200, 0, 0);
                        doc.setFont(undefined, 'bold');
                        doc.text(`${entry.issues.length} ERROR${entry.issues.length > 1 ? 'S' : ''} FOUND:`, 15, yPos);
                        doc.setFont(undefined, 'normal');
                        yPos += 6;
                        
                        // List each error clearly
                        entry.issues.forEach((issue, idx) => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                            
                            doc.setFontSize(9);
                            
                            // Error type icon
                            const icon = issue.type === 'typo' ? '[SPELL]' :
                                       issue.type === 'grammar' ? '[GRAM]' :
                                       issue.type === 'pronoun' ? '[PRON]' :
                                       issue.type === 'prohibited' ? '[BAN]' :
                                       issue.type === 'capitalization' ? '[CAP]' : '[DIR]';
                            
                            doc.setTextColor(150, 0, 0);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${idx + 1}. ${icon}`, 20, yPos);
                            doc.setFont(undefined, 'normal');
                            
                            // Show the error and correction
                            doc.setTextColor(200, 0, 0);
                            doc.text(`"${issue.word}"`, 45, yPos);
                            doc.setTextColor(0, 0, 0);
                            doc.text(`‚Üí`, 45 + doc.getTextWidth(`"${issue.word}"`) + 2, yPos);
                            doc.setTextColor(0, 150, 0);
                            doc.text(`"${issue.suggestion}"`, 45 + doc.getTextWidth(`"${issue.word}"`) + 7, yPos);
                            yPos += 4;
                            
                            // Show context from comment (where the error appears)
                            doc.setFontSize(8);
                            doc.setTextColor(100, 100, 100);
                            const context = getErrorContext(entry.comment, issue.word);
                            const contextLines = doc.splitTextToSize(`Context: ...${context}...`, 170);
                            contextLines.forEach(line => {
                                if (yPos > 275) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                doc.text(line, 25, yPos);
                                yPos += 3.5;
                            });
                            yPos += 2;
                        });
                        
                        yPos += 3;
                        
                        // Full original comment
                        doc.setFontSize(9);
                        doc.setTextColor(0, 102, 179);
                        doc.setFont(undefined, 'bold');
                        doc.text('FULL COMMENT:', 15, yPos);
                        doc.setFont(undefined, 'normal');
                        yPos += 5;
                        
                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        const commentLines = doc.splitTextToSize(entry.comment, 180);
                        commentLines.forEach(line => {
                            if (yPos > 280) {
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, 15, yPos);
                            yPos += 4;
                        });
                        
                        // Separator
                        yPos += 5;
                        doc.setDrawColor(200, 200, 200);
                        doc.line(15, yPos, 195, yPos);
                        yPos += 10;
                    });
                });
                
                // Reference guide
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(0, 102, 179);
                doc.setFont(undefined, 'bold');
                doc.text('Quick Reference Guide', 15, 20);
                doc.setFont(undefined, 'normal');
                
                let y = 35;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                const guides = [
                    { title: 'Error Codes:', items: [
                        '[SPELL] - Spelling error',
                        '[GRAM] - Grammar error',
                        '[PRON] - Wrong pronoun (gender)',
                        '[BAN] - Prohibited word used',
                        '[CAP] - Needs capitalization',
                        '[DIR] - Direct address (you/your)'
                    ]},
                    { title: 'Common Replacements:', items: [
                        'but ‚Üí however',
                        'can ‚Üí is able to',
                        'needs ‚Üí requires',
                        'struggles ‚Üí finds it challenging',
                        'student ‚Üí learner',
                        'you/your ‚Üí remove or rewrite'
                    ]}
                ];
                
                guides.forEach(guide => {
                    doc.setFont(undefined, 'bold');
                    doc.text(guide.title, 15, y);
                    doc.setFont(undefined, 'normal');
                    y += 7;
                    
                    doc.setFontSize(10);
                    guide.items.forEach(item => {
                        doc.text(`‚Ä¢ ${item}`, 20, y);
                        y += 6;
                    });
                    y += 5;
                    doc.setFontSize(11);
                });
                
                // Save
                const timestamp = new Date().toISOString().slice(0, 10);
                doc.save(`Comment_Errors_${timestamp}.pdf`);
                
                showStatus('‚úì PDF downloaded successfully', 'success');
                
            } catch (error) {
                showStatus('‚úó Error creating PDF: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Helper function to get context around an error word
        function getErrorContext(comment, errorWord) {
            const words = comment.split(/\s+/);
            const errorIndex = words.findIndex(w => 
                w.replace(/[.,;!?]/g, '').toLowerCase() === errorWord.toLowerCase()
            );
            
            if (errorIndex === -1) return comment.substring(0, 50);
            
            const start = Math.max(0, errorIndex - 3);
            const end = Math.min(words.length, errorIndex + 4);
            return words.slice(start, end).join(' ');
        }

        function downloadResults() {
            if (!processedData) {
                showStatus('‚úó No processed data to download', 'error');
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                
                // Create ERROR REPORT sheet (priority!)
                if (qualityIssues.size > 0) {
                    const errorReportData = [
                        ['COMMENT ERROR REPORT - FOR TEACHERS TO FIX'],
                        ['Generated: ' + new Date().toLocaleString()],
                        [],
                        ['‚ö†Ô∏è This report lists ALL errors found in comments that need to be corrected.'],
                        ['Teachers should review and fix these issues in their original comments.'],
                        [],
                        ['Student Name', 'Student Number', 'Grade', 'Gender', 'Subject', 'Teacher', 'Error Type', 'Incorrect Text', 'Correct Text', 'Error Message', 'Full Comment']
                    ];
                    
                    processedData.forEach((student, studentIdx) => {
                        if (qualityIssues.has(studentIdx)) {
                            const studentIssues = qualityIssues.get(studentIdx);
                            
                            studentIssues.forEach(subjectIssue => {
                                const subject = student.subjects.find(s => s.name === subjectIssue.subject);
                                
                                subjectIssue.issues.forEach(issue => {
                                    let errorType = '';
                                    switch(issue.type) {
                                        case 'typo': errorType = 'Spelling Error'; break;
                                        case 'grammar': errorType = 'Grammar Error'; break;
                                        case 'pronoun': errorType = 'Pronoun Error (Gender)'; break;
                                        case 'prohibited': errorType = 'Prohibited Word'; break;
                                        case 'capitalization': errorType = 'Subject Capitalization'; break;
                                        case 'direct-address': errorType = 'Direct Address (You/Your)'; break;
                                        default: errorType = issue.type;
                                    }
                                    
                                    errorReportData.push([
                                        student.name,
                                        student.studentNumber || 'N/A',
                                        student.grade,
                                        student.gender,
                                        subjectIssue.subject,
                                        subject ? subject.teacher : '',
                                        errorType,
                                        issue.word,
                                        issue.suggestion,
                                        issue.message,
                                        subjectIssue.comment
                                    ]);
                                });
                            });
                        }
                    });
                    
                    const errorSheet = XLSX.utils.aoa_to_sheet(errorReportData);
                    
                    // Set column widths
                    errorSheet['!cols'] = [
                        {wch: 30}, // Student Name
                        {wch: 15}, // Student Number
                        {wch: 10}, // Grade
                        {wch: 10}, // Gender
                        {wch: 30}, // Subject
                        {wch: 20}, // Teacher
                        {wch: 25}, // Error Type
                        {wch: 20}, // Incorrect Text
                        {wch: 20}, // Correct Text
                        {wch: 40}, // Error Message
                        {wch: 80}  // Full Comment
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, errorSheet, 'ERROR REPORT');
                }
                
                // Create SUMMARY sheet
                const summaryData = [
                    ['Subject Comment Report - Processing Summary'],
                    ['Generated: ' + new Date().toLocaleString()],
                    [],
                    ['Total Students Processed:', processedData.length],
                    ['Students with Errors:', qualityIssues.size],
                    ['Students with No Errors:', processedData.length - qualityIssues.size],
                    [],
                    ['Student Name', 'Student Number', 'Grade', 'Gender', 'Name Status', 'Number of Subjects', 'Number of Errors']
                ];
                
                processedData.forEach((student, idx) => {
                    const errorCount = qualityIssues.has(idx) ? 
                        qualityIssues.get(idx).reduce((sum, si) => sum + si.issues.length, 0) : 0;
                    
                    summaryData.push([
                        student.name,
                        student.studentNumber || 'N/A',
                        student.grade,
                        student.gender,
                        student.nameMatched ? 'Matched' : 'Original',
                        student.subjects.length,
                        errorCount
                    ]);
                });
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
                
                // Create SCHOOL RULES sheet
                const rulesData = [
                    ['CURRO RIVONIA - SUBJECT COMMENT WRITING RULES'],
                    [],
                    ['GENERAL PRINCIPLES:'],
                    ['1. Use the learner\'s first name exactly as it appears on the class list. Do not use nicknames.'],
                    ['2. Do not use "you" or "your."'],
                    ['3. Do not address the learner directly in subject comments.'],
                    ['4. Use correct pronouns (he / she / they) based on gender.'],
                    ['5. Capitalise subject names when referring to them.'],
                    ['6. Use "learner" instead of "student."'],
                    ['7. Always use British spelling (e.g., realise, emphasise, organise).'],
                    ['8. Keep the tone formal, encouraging, and forward-looking.'],
                    ['9. Do not comment on personality traits. Focus on academic performance.'],
                    ['10. Refer specifically to assessments or learning areas covered in the term.'],
                    ['11. Ensure comments are balanced: highlight strengths and suggest improvements.'],
                    [],
                    ['PROHIBITED WORDS AND REPLACEMENTS:'],
                    ['Prohibited Word', 'Use Instead'],
                    ['but', 'however'],
                    ['can', 'is able to'],
                    ['needs/needed/need', 'requires/required/require'],
                    ['struggles', 'finds it challenging'],
                    ['student/students', 'learner/learners'],
                    ['you/your', '[remove - do not use]'],
                    ['organize', 'organise (UK spelling)'],
                    ['recognize', 'recognise (UK spelling)'],
                    ['realize', 'realise (UK spelling)'],
                    ['emphasize', 'emphasise (UK spelling)'],
                    ['finalize', 'finalise (UK spelling)'],
                    ['symbolize', 'symbolise (UK spelling)'],
                    [],
                    ['SUBJECT NAMES (Must be Capitalized):'],
                ];
                
                subjectNames.forEach(name => {
                    rulesData.push([name]);
                });
                
                const rulesSheet = XLSX.utils.aoa_to_sheet(rulesData);
                rulesSheet['!cols'] = [{wch: 50}, {wch: 50}];
                XLSX.utils.book_append_sheet(wb, rulesSheet, 'School Rules');
                
                // Create individual sheets for each student
                processedData.forEach((student, index) => {
                    const studentData = [
                        ['Student:', student.name],
                        ['Number:', student.studentNumber || 'N/A'],
                        ['Grade:', student.grade],
                        ['Gender:', student.gender],
                        ['Name Status:', student.nameMatched ? 'Matched from Educator List' : 'Original from Report'],
                        [],
                        ['Subject', 'Mark', 'Teacher', 'Comment', 'Errors Found']
                    ];
                    
                    student.subjects.forEach(subject => {
                        let errorsText = 'None';
                        
                        if (qualityIssues.has(index)) {
                            const studentIssues = qualityIssues.get(index);
                            const subjectIssue = studentIssues.find(si => si.subject === subject.name);
                            
                            if (subjectIssue && subjectIssue.issues.length > 0) {
                                errorsText = subjectIssue.issues.map(issue => 
                                    `${issue.word} ‚Üí ${issue.suggestion} (${issue.type})`
                                ).join('; ');
                            }
                        }
                        
                        studentData.push([
                            subject.name,
                            subject.mark || '',
                            subject.teacher || '',
                            subject.comment || '',
                            errorsText
                        ]);
                    });
                    
                    const studentSheet = XLSX.utils.aoa_to_sheet(studentData);
                    
                    studentSheet['!cols'] = [
                        {wch: 30},  // Subject
                        {wch: 8},   // Mark
                        {wch: 20},  // Teacher
                        {wch: 80},  // Comment
                        {wch: 60}   // Errors
                    ];
                    
                    let sheetName = student.name.replace(/[\\\/\?\*\[\]]/g, '').substring(0, 31);
                    XLSX.utils.book_append_sheet(wb, studentSheet, sheetName);
                });
                
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `Comment_Report_with_Errors_${timestamp}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showStatus('‚úì File downloaded: ' + filename, 'success');
                
            } catch (error) {
                showStatus('‚úó Error creating download file: ' + error.message, 'error');
                console.error(error);
            }
        }

    </script>
    
    <!-- Firebase v9+ Modular SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;
            } else {
                // User is signed out
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            loginError.style.display = 'none';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Success - auth state change will handle UI update
            } catch (error) {
                loginError.textContent = getErrorMessage(error.code);
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        // Logout function - make it global
        window.logout = function() {
            signOut(auth).then(() => {
                // Clear any processed data
                window.commentReportData = null;
                window.educatorListData = null;
                window.processedData = null;
                window.qualityIssues.clear();
                document.getElementById('resultsContainer').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'none';
            });
        }

        // User-friendly error messages
        function getErrorMessage(errorCode) {
            switch(errorCode) {
                case 'auth/invalid-email':
                    return 'Invalid email address format.';
                case 'auth/user-disabled':
                    return 'This account has been disabled.';
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/invalid-credential':
                    return 'Invalid email or password.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                default:
                    return 'Login failed. Please try again.';
            }
        }
    </script>
</div> <!-- Close mainApp -->
</body>
</html>
